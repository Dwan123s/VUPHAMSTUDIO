<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Tra cứu ảnh - VU PHAM STUDIO</title>
    <link rel="stylesheet" href="style.css"/>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="main-container">
            <div class="logo">VU PHAM STUDIO</div>
            <nav>
                <a href="index.html">Trang chủ</a>
                <a href="dich-vu.html">Dịch vụ</a>
                <a href="bang-gia.html">Bảng giá</a>
                <a href="tra-cuu.html" class="active"><strong>Tra Cứu Ảnh</strong></a>
                <a href="lien-he.html">Liên hệ</a>
            </nav>
        </div>
    </header>

    <main>
        <section class="main-container section-lookup">
            <div class="lookup-intro">
                <h1 class="page-title">Kho ảnh cá nhân</h1>
                <p>Nhập mã số khách hàng được cung cấp để xem, tải xuống hoặc chia sẻ hình ảnh của bạn một cách nhanh chóng và bảo mật.</p>
            </div>

            <div class="lookup-box">
                <div class="search-area">
                    <label for="code" class="sr-only">Nhập mã số khách hàng</label>
                    <div class="input-wrapper">
                        <input id="code" type="text" placeholder="Nhập mã số của bạn..." autocomplete="off" inputmode="text"/>
                        <button id="clear-btn" title="Xóa" type="button" aria-label="Xóa mã đã nhập">&times;</button>
                        <button id="btn" type="button" class="btn">
                            <span>Tra cứu</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg>
                        </button>
                    </div>
                </div>
                
                <div id="result">
                    <p class="message">Kết quả tra cứu sẽ được hiển thị tại đây.</p>
                </div>

                <div id="history-container" aria-live="polite">
                    <h3>Lịch sử tra cứu gần đây</h3>
                    <ul id="history-list"></ul>
                </div>
            </div>
        </section>
    </main>
    
    <footer>
        <div class="main-container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h4>VU PHAM STUDIO</h4>
                    <p>Nơi hình ảnh không chỉ là một bức hình, mà là một câu chuyện về sự chuyên nghiệp của bạn.</p>
                </div>
                 <div class="footer-col">
                    <h4>Liên kết nhanh</h4>
                    <a href="index.html">Trang chủ</a>
                    <a href="dich-vu.html">Dịch vụ</a>
                    <a href="lien-he.html">Liên hệ</a>
                </div>
                 <div class="footer-col">
                    <h4>Liên hệ</h4>
                    <p>11 Lê Thiện Trị, Ngũ Hành Sơn, Đà Nẵng</p>
                    <p>studiovupham@gmail.com</p>
                    <p>0987.654.321</p>
                </div>
            </div>
            <div class="footer-bottom">
                &copy; 2025 VU PHAM Studio. Designed with Elegance.
            </div>
        </div>
    </footer>

<script>
    const API = "https://script.google.com/macros/s/AKfycbzuvdWv9IKtWJ0DiQkANjVibpEvvTyqQVBwvb5Rw13oiniT9IfOvpgiEwKbL4AOcZTZUw/exec";

    const codeEl = document.getElementById('code');
    const btn = document.getElementById('btn');
    const resultEl = document.getElementById('result');
    const clearBtn = document.getElementById('clear-btn');
    const historyContainer = document.getElementById('history-container');
    const historyListEl = document.getElementById('history-list');

    // Icons
    const iconDownload = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>`;
    const iconDrive = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.243 10.424L12.011 20.499L4.757 10.424L8.389 4H15.611L19.243 10.424ZM22 10.5L15.75 0H8.25L2 10.5L12.011 24L22 10.5Z"/></svg>`;
    const iconCopy = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"/></svg>`;
    const iconError = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/></svg>`;
    const srOnly = `<span class="sr-only">(opens in a new tab)</span>`;

    // Events
    btn.addEventListener('click', search);
    codeEl.addEventListener('keypress', e => { if (e.key === 'Enter') search(); });
    codeEl.addEventListener('input', () => { clearBtn.style.display = codeEl.value ? 'block' : 'none'; });
    clearBtn.addEventListener('click', () => {
        codeEl.value = '';
        clearBtn.style.display = 'none';
        codeEl.focus();
        resultEl.innerHTML = `<p class="message">Kết quả tra cứu sẽ được hiển thị tại đây.</p>`;
    });

    document.body.addEventListener('click', e => {
        const copyBtn = e.target.closest('.copy-link');
        const historyLink = e.target.closest('#history-list a');

        if (copyBtn) {
            e.preventDefault();
            const linkToCopy = copyBtn.dataset.link;
            navigator.clipboard.writeText(linkToCopy).then(() => {
                copyBtn.innerHTML = '✅<span class="sr-only">Đã sao chép</span>';
                setTimeout(() => { copyBtn.innerHTML = iconCopy; }, 2000);
            }).catch(() => alert('Sao chép thất bại!'));
        }

        if (historyLink) {
            e.preventDefault();
            codeEl.value = historyLink.dataset.code;
            clearBtn.style.display = 'block';
            search();
            historyLink.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });

    // Main Function
    let isBusy = false;
    async function search() {
        const code = (codeEl.value || "").trim();
        if (!code) {
            resultEl.innerHTML = `<div class='message error'>${iconError} <div><b>Vui lòng nhập mã của bạn</b></div></div>`;
            return;
        }
        if (isBusy) return;

        isBusy = true;
        btn.disabled = true;
        resultEl.innerHTML = "<div class='spinner' aria-label='Đang tải'></div>";

        try {
            const res = await fetch(`${API}?code=${encodeURIComponent(code)}`);
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            const data = await res.json();

            if (!data.ok || !Array.isArray(data.items) || data.items.length === 0) {
                resultEl.innerHTML = `<div class='message error'>${iconError}<div><b>Không tìm thấy mã: ${escapeHTML(code)}</b><br><small>Vui lòng kiểm tra lại hoặc liên hệ studio.</small></div></div>`;
                return;
            }
            
            saveToHistory(code, data.items[0]?.name);
            resultEl.innerHTML = data.items.map((item, index) => cardTemplate(item, index)).join("");

        } catch (error) {
            console.error("Search failed:", error);
            resultEl.innerHTML = `<div class='message error'>${iconError} <div><b>Lỗi kết nối máy chủ</b><br><small>Vui lòng thử lại sau.</small></div></div>`;
        } finally {
            isBusy = false;
            btn.disabled = false;
        }
    }

    // Card Template
    function cardTemplate(item, index) {
        const name = item.name ? `<span>Khách hàng: <b>${escapeHTML(item.name)}</b></span>` : "";
        const code = `<span>Mã ảnh: <b>${escapeHTML(item.code || "")}</b></span>`;
        return `
        <div class="photo-card" style="--delay: ${index * 100}ms">
            <div class="photo-card-img-wrapper">
                <img src="${item.direct}" alt="Ảnh của ${escapeHTML(item.name || item.code)}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="img-fallback">${iconError} Không tải được ảnh</div>
            </div>
            <div class="photo-card-info">
                <div class="meta-info">${name}${code}</div>
                <div class="actions">
                    <a href="${item.direct}" download title="Tải ảnh">${iconDownload}</a>
                    <a href="${item.webView}" target="_blank" rel="noopener noreferrer" title="Xem trên Drive">${iconDrive}${srOnly}</a>
                    <a href="#" class="copy-link" data-link="${item.direct}" title="Sao chép link">${iconCopy}</a>
                </div>
            </div>
        </div>`;
    }

    // History Functions
    function saveToHistory(code, name) {
        let history = JSON.parse(localStorage.getItem('photoSearchHistory')) || [];
        history = history.filter(it => it.code.toLowerCase() !== code.toLowerCase());
        history.unshift({ code, name: name || 'N/A' });
        if (history.length > 10) history = history.slice(0, 10);
        localStorage.setItem('photoSearchHistory', JSON.stringify(history));
        loadHistory();
    }

    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('photoSearchHistory')) || [];
        if (history.length > 0) {
            historyContainer.style.display = 'block';
            historyListEl.innerHTML = history.map(it =>
                `<li><a href="#" data-code="${escapeHTML(it.code)}" title="Tra cứu lại mã ${escapeHTML(it.code)}">${escapeHTML(it.code)}</a></li>`
            ).join('');
        } else {
            historyContainer.style.display = 'none';
        }
    }
    
    function escapeHTML(str) {
        const p = document.createElement("p");
        p.textContent = str;
        return p.innerHTML;
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        loadHistory();
        const urlCode = new URLSearchParams(location.search).get('code');
        if (urlCode) {
            codeEl.value = urlCode;
            clearBtn.style.display = 'block';
            search();
        }
    });
</script>
</body>
</html>